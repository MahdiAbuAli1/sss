# 1_knowledge_pipeline/cleaners.py
# -----------------------------------------------------------------------------
# هذه الوحدة مسؤولة عن تنظيف المحتوى النصي للمستندات المحملة.
# يزيل الشوائب الشائعة مثل المسافات الزائدة وفواصل الأسطر غير المرغوب فيها.
# -----------------------------------------------------------------------------
# 1_knowledge_pipeline/cleaners.py (نسخة محدثة وآمنة)
# -----------------------------------------------------------------------------
# هذه الوحدة مسؤولة عن تنظيف المحتوى النصي للمستندات المحملة.
# -----------------------------------------------------------------------------

import re
from typing import List
from langchain_core.documents import Document

def clean_documents(documents: List[Document]) -> List[Document]:
    """
    يقوم بتنفيذ سلسلة من عمليات التنظيف على محتوى كل مستند في القائمة.
    تم تصميم هذه النسخة لتكون أقل عدوانية وتحافظ على تنسيق القوائم.
    """
    print(f"\n[+] المرحلة 2: تنظيف {len(documents)} جزء/صفحة...")
    
    for doc in documents:
        content = doc.page_content
        
        # 1. إزالة المسافات البيضاء الزائدة من البداية والنهاية
        content = content.strip()
        
        # 2. استبدال 3 فواصل أسطر أو أكثر بفاصلين فقط للحفاظ على الفقرات
        content = re.sub(r'\n{3,}', '\n\n', content)
        
        # 3. استبدال المسافات المتعددة بمسافة واحدة (باستثناء فواصل الأسطر)
        content = re.sub(r' +', ' ', content)

        # 4. (مهم) إزالة المسافات بين الكلمات العربية والحروف اللاتينية المتصلة
        # مثال: "الشبكاتالعصبية" -> "الشبكات العصبية"
        # هذا يعالج مشكلة شائعة في نسخ النصوص من PDF
        content = re.sub(r'([_,-])', ' ', content)
        content = re.sub(r'([ا-ي])([A-Za-z])', r'\1 \2', content)
        content = re.sub(r'([A-Za-z])([ا-ي])', r'\1 \2', content)

        # 5. (اختياري وآمن) إزالة فواصل الأسطر داخل الجمل التي تنتهي بنقطة
        # هذا السطر آمن لأنه يستهدف فقط الأسطر التي هي جزء من نفس الجملة
        # content = re.sub(r'(?<=[^\n.!?])\n(?=[^\n\s])', ' ', content)
        # سنقوم بتعطيل هذا السطر حاليًا لأنه قد يكون لا يزال عدوانيًا.
        # الأفضل هو الاعتماد على التقطيع الجيد لاحقًا.

        # تحديث محتوى المستند
        doc.page_content = content
            
    print("[*] اكتمل تنظيف النصوص.")
    return documents
