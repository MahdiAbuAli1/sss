<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenSoft - واجهة محادثة متقدمة</title>
  <style>
    /* --- Base & Theming --- */
    :root {
      --font-family: 'Inter', 'Segoe UI', Tahoma, sans-serif;
      --border-radius-lg: 1.5rem; /* 24px */
      --border-radius-md: 1rem;   /* 16px */
      --border-radius-sm: 0.75rem; /* 12px */
    }

    /* Light Theme (Default) */
    html[data-theme='light'] {
      --bg-color: #f9fafb;
      --panel-bg: #ffffff;
      --chat-bg: #f9fafb;
      --border-color: #e5e7eb;
      --text-color: #111827;
      --subtext-color: #6b7280;
      --user-bubble-bg: #3b82f6;
      --user-bubble-text: #ffffff;
      --ai-bubble-bg: #f3f4f6;
      --input-bg: #f3f4f6;
      --icon-color: #4b5563;
      --icon-hover-bg: #e5e7eb;
    }

    /* Dark Theme */
    html[data-theme='dark'] {
      --bg-color: #111827;
      --panel-bg: #1f2937;
      --chat-bg: #111827;
      --border-color: #374151;
      --text-color: #f9fafb;
      --subtext-color: #9ca3af;
      --user-bubble-bg: #2563eb;
      --user-bubble-text: #ffffff;
      --ai-bubble-bg: #374151;
      --input-bg: #374151;
      --icon-color: #9ca3af;
      --icon-hover-bg: #4b5563;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-family);
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: 100vh;
    }
    
    html {
        height: 100vh;
    }

    .main-container {
      display: flex;
      justify-content: center;
      padding: 1rem;
      height: 100%;
    }

    .chat-window {
      width: 100%;
      max-width: 840px;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--panel-bg);
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--border-color);
      box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    /* --- Header --- */
    .chat-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .chat-header h1 { font-size: 1.125rem; font-weight: 600; }
    .header-actions { display: flex; align-items: center; gap: 0.5rem; }
    .icon-btn {
      background: transparent; border: none; cursor: pointer;
      width: 40px; height: 40px; border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
      color: var(--icon-color); transition: background-color 0.2s, color 0.2s;
    }
    .icon-btn:hover { background-color: var(--icon-hover-bg); }
    .icon-btn svg { width: 22px; height: 22px; }

    /* --- Settings Panel --- */
    .settings-panel {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--chat-bg);
      display: none; /* Hidden by default */
      flex-direction: column; gap: 1rem;
    }
    .settings-panel.visible { display: flex; }
    .setting-item { display: flex; flex-direction: column; gap: 0.5rem; }
    .setting-item label { font-size: 0.875rem; font-weight: 500; color: var(--subtext-color); }
    .setting-item input, .setting-item select {
      width: 100%; padding: 0.75rem;
      border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);
      background-color: var(--input-bg); color: var(--text-color);
      font-size: 1rem;
    }

    /* --- Chat Body --- */
    .chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .message-group { display: flex; gap: 0.75rem; max-width: 85%; }
    .message-group.user { align-self: flex-end; flex-direction: row-reverse; }
    .message-group.ai { align-self: flex-start; }
    
    .avatar {
      width: 36px; height: 36px; border-radius: 50%;
      flex-shrink: 0; margin-top: 4px;
    }
    .avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    
    .message-content { display: flex; flex-direction: column; gap: 0.25rem; }
    .message-bubble {
      padding: 0.875rem 1.25rem;
      border-radius: var(--border-radius-md);
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .message-group.user .message-bubble {
      background-color: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      border-bottom-left-radius: var(--border-radius-sm);
      border-bottom-right-radius: 0.25rem;
    }
    .message-group.ai .message-bubble {
      background-color: var(--ai-bubble-bg);
      border: 1px solid var(--border-color);
      border-bottom-right-radius: var(--border-radius-sm);
      border-bottom-left-radius: 0.25rem;
    }

    /* Indicators (Thinking/Typing) */
    .indicator-group .message-content {
        /* Ensure the indicator group content is aligned correctly */
        align-items: flex-start;
    }
    .indicator-bubble {
      display: inline-flex; align-items: center; gap: 0.75rem;
      color: var(--subtext-color); font-weight: 500;
      /* Style the bubble to look like a message bubble */
      padding: 0.875rem 1.25rem;
      border-radius: var(--border-radius-md);
      background-color: var(--ai-bubble-bg);
      border: 1px solid var(--border-color);
      border-bottom-right-radius: var(--border-radius-sm);
      border-bottom-left-radius: 0.25rem;
    }

    /* Removed unnecessary indicator-bubble svg/animation CSS */
    .typing-dots { 
        display: flex; gap: 4px; 
        align-items: center; /* Align dots vertically with text */
    }
    .typing-dots span {
      width: 8px; height: 8px; border-radius: 50%;
      background-color: var(--subtext-color);
      animation: pulse 1.4s infinite ease-in-out;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse {
        0%, 80%, 100% { transform: scale(0.5); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    /* --- Chat Footer --- */
    .chat-footer {
      padding: 1rem 1.5rem 1.5rem;
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      background-color: var(--input-bg);
      border-radius: var(--border-radius-md);
      border: 1px solid var(--border-color);
    }
    .input-wrapper:focus-within { border-color: var(--user-bubble-bg); }
    textarea {
      flex: 1;
      height: 56px;
      max-height: 200px;
      padding: 1rem 1.25rem;
      padding-right: 4rem;
      resize: none; border: none; background: transparent;
      color: var(--text-color); font-size: 1rem;
      line-height: 1.5;
    }
    textarea:focus { outline: none; }
    
    #send-stop-btn {
      position: absolute;
      right: 0.75rem;
      top: 50%; transform: translateY(-50%);
      width: 40px; height: 40px;
      border-radius: 50%; border: none;
      background-color: var(--user-bubble-bg); color: var(--user-bubble-text);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform 0.3s ease, background-color 0.3s;
    }
    #send-stop-btn.streaming {
      background-color: var(--subtext-color);
      transform: translateY(-50%) rotate(180deg);
    }
    #send-stop-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
    #send-stop-btn svg { width: 20px; height: 20px; }

  </style>
</head>
<body>

  <div class="main-container">
    <div class="chat-window">
      <header class="chat-header">
        <h1>مساعد الدعم</h1>
        <div class="header-actions">
          <button id="settings-toggle" class="icon-btn" title="الإعدادات">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
          </button>
          <button id="theme-toggle" class="icon-btn" title="تبديل الوضع"></button>
        </div>
      </header>

      <div id="settings-panel" class="settings-panel">
        <div class="setting-item">
          <label for="tenant">اختر النظام</label>
          <select id="tenant"></select>
        </div>
        <div class="setting-item">
          <label for="apikey">مفتاح API</label>
          <input id="apikey" type="password" placeholder="أدخل مفتاح API الخاص بك هنا" />
        </div>
      </div>

      <div id="chat-body" class="chat-body"></div>

      <div class="chat-footer">
        <div class="input-wrapper">
          <textarea id="msg-input" placeholder="اكتب رسالتك..." rows="1"></textarea>
          <button id="send-stop-btn" title="إرسال"></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- DOM Elements ---
    const chatBody = document.getElementById('chat-body' );
    const msgInput = document.getElementById('msg-input');
    const sendStopBtn = document.getElementById('send-stop-btn');
    const tenantSelect = document.getElementById('tenant');
    const apiKeyInput = document.getElementById('apikey');
    const themeToggleBtn = document.getElementById('theme-toggle');
    const settingsToggleBtn = document.getElementById('settings-toggle');
    const settingsPanel = document.getElementById('settings-panel');
    const htmlEl = document.documentElement;

    // --- SVG Icons ---
    const sendIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>`;
    const stopIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.5 7.5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-9a3 3 0 01-3-3v-9z" clip-rule="evenodd" /></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>`;
    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>`;
    // Removed unused thinkingIconSVG
    const robotImageUrl = 'https://i.ibb.co/9vVz8Tt/robot.png';

    // --- State ---
    let abortController = null;

    // --- UI Functions ---
    function applyTheme(theme ) {
        htmlEl.setAttribute('data-theme', theme);
        themeToggleBtn.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
        localStorage.setItem('chatTheme', theme);
    }

    function setButtonState(state) { // 'send', 'streaming', 'disabled'
        sendStopBtn.disabled = (state === 'disabled');
        if (state === 'streaming') {
            sendStopBtn.innerHTML = stopIcon;
            sendStopBtn.classList.add('streaming');
            sendStopBtn.title = 'إيقاف';
        } else {
            sendStopBtn.innerHTML = sendIcon;
            sendStopBtn.classList.remove('streaming');
            sendStopBtn.title = 'إرسال';
        }
    }
    
    function createMessageGroup(sender, content, isIndicator = false) {
        const group = document.createElement('div');
        group.className = `message-group ${sender} ${isIndicator ? 'indicator-group' : ''}`;
        
        // Only AI messages get an avatar
        if (sender === 'ai') {
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            const img = document.createElement('img');
            img.src = robotImageUrl;
            img.alt = 'AI Avatar';
            avatar.appendChild(img);
            group.appendChild(avatar);
        }
        
        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'message-content';
        
        const bubble = document.createElement('div');
        bubble.className = isIndicator ? 'indicator-bubble' : 'message-bubble';
        bubble.innerHTML = content;
        
        contentWrapper.appendChild(bubble);
        group.appendChild(contentWrapper);

        chatBody.appendChild(group);
        chatBody.scrollTop = chatBody.scrollHeight;
        
        return { group, bubble };
    }
    
    function addUserMessage(text) {
        const group = document.createElement('div');
        group.className = 'message-group user';
        
        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'message-content';
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = text;
        
        contentWrapper.appendChild(bubble);
        group.appendChild(contentWrapper);
        
        chatBody.appendChild(group);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    // --- Event Listeners ---
    themeToggleBtn.addEventListener('click', () => {
        const currentTheme = htmlEl.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
    });

    settingsToggleBtn.addEventListener('click', () => {
        settingsPanel.classList.toggle('visible');
    });

    msgInput.addEventListener('input', () => {
        msgInput.style.height = 'auto';
        const scrollHeight = msgInput.scrollHeight;
        msgInput.style.height = `${scrollHeight + 2}px`; 
    });

    sendStopBtn.addEventListener('click', () => {
        if (abortController) { 
            abortController.abort();
        } else {
            handleSend();
        }
    });
    
    msgInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    });

    // --- Core Logic ---
    async function loadTenants() {
        const tenantApiUrl = '/tenants'; 

        try {
            const res = await fetch(tenantApiUrl);
            if (!res.ok) throw new Error('Failed to load');
            const data = await res.json();
            tenantSelect.innerHTML = (data.tenants || []).map(t => `<option value="${t}">${t}</option>`).join('');
        } catch (e) {
            console.error('Error loading tenants:', e);
            tenantSelect.innerHTML = '<option value="">فشل التحميل</option>';
        }
    }

    async function handleSend() {
        const question = msgInput.value.trim();
        const apiKey = apiKeyInput.value.trim();
        
        if (!question) return; 

        if (!apiKey) {
            alert('الرجاء إدخال مفتاح API في الإعدادات.');
            return;
        }

        addUserMessage(question);
        msgInput.value = '';
        msgInput.style.height = '56px';

        setButtonState('streaming');
        sendStopBtn.disabled = false;

        abortController = new AbortController();
        const { signal } = abortController;

        // Create the "Searching..." indicator with animated dots
        const indicatorContent = `
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
            جارِ البحث...
        `;
        const { group: indicatorGroup, bubble: indicatorBubble } = createMessageGroup('ai', indicatorContent, true); 
        
        let aiBubble = null;

        try {
            const streamApiUrl = '/ask-stream';
            
            const res = await fetch(streamApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey },
                body: JSON.stringify({ question, tenant_id: tenantSelect.value, k_results: 6 }),
                signal
            });

            if (!res.ok) throw new Error((await res.text()) || `خطأ: ${res.status}`);

            // The indicator group is the first AI message, we will transform it into the actual message
            // by changing its class name and content.
            indicatorGroup.classList.remove('indicator-group');
            indicatorBubble.classList.remove('indicator-bubble');
            indicatorBubble.classList.add('message-bubble');
            aiBubble = indicatorBubble;
            aiBubble.textContent = ''; // Clear indicator content for streaming

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                
                let newlineIndex;
                while ((newlineIndex = buffer.indexOf('\n')) >= 0) {
                    const line = buffer.slice(0, newlineIndex).trim();
                    buffer = buffer.slice(newlineIndex + 1);
                    if (line) {
                        try {
                            const data = JSON.parse(line);
                            if (data.chunk) {
                                aiBubble.innerHTML += data.chunk; 
                                chatBody.scrollTop = chatBody.scrollHeight;
                            } else if (data.error) {
                                throw new Error(data.error);
                            }
                        } catch (e) { 
                            console.warn('Invalid JSON line:', line, e); 
                            aiBubble.textContent += line; 
                        }
                    }
                }
            }
            
            // Process any remaining buffer content
            if (buffer.trim()) {
                try {
                    const data = JSON.parse(buffer.trim());
                    if (data.chunk) {
                        aiBubble.innerHTML += data.chunk;
                    } else if (data.error) {
                        throw new Error(data.error);
                    }
                } catch (e) {
                    console.warn('Invalid JSON in final buffer:', buffer.trim(), e);
                    aiBubble.textContent += buffer.trim();
                }
            }

        } catch (err) {
            // Remove or transform the indicator/message bubble on error/abort
            if (err.name === 'AbortError') {
                // If streaming started (aiBubble exists), append status to it
                if (aiBubble) {
                    aiBubble.innerHTML += `<br><br><strong>(تم إيقاف الاستجابة من قبل المستخدم)</strong>`;
                } else {
                    // If streaming hasn't started, replace indicator with status
                    indicatorGroup.remove();
                    createMessageGroup('ai', 'تم إيقاف الاستجابة من قبل المستخدم.');
                }
            } else {
                const errorMessage = `حدث خطأ: ${err.message || 'خطأ غير معروف'}`;
                if (aiBubble) {
                    aiBubble.innerHTML += `<br><br><strong>${errorMessage}</strong>`;
                } else {
                    indicatorGroup.remove();
                    createMessageGroup('ai', errorMessage);
                }
            }
        } finally {
            setButtonState('send');
            abortController = null;
        }
    }

    // --- Initialization ---
    (function init() {
        const savedTheme = localStorage.getItem('chatTheme') || 'light';
        applyTheme(savedTheme);
        setButtonState('send');
        loadTenants();
        setTimeout(() => {
             createMessageGroup('ai', 'أهلاً بك! أدخل مفتاح API في الإعدادات (⚙️) لبدء المحادثة.');
        }, 100);
    })();
  </script>
</body>
</html>