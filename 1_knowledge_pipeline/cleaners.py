# # 1_knowledge_pipeline/cleaners.py
# # -----------------------------------------------------------------------------
# # ูุฐู ุงููุญุฏุฉ ูุณุคููุฉ ุนู ุชูุธูู ุงููุญุชูู ุงููุตู ูููุณุชูุฏุงุช ุงููุญููุฉ.
# # ูุฒูู ุงูุดูุงุฆุจ ุงูุดุงุฆุนุฉ ูุซู ุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ ูููุงุตู ุงูุฃุณุทุฑ ุบูุฑ ุงููุฑุบูุจ ูููุง.
# # -----------------------------------------------------------------------------
# # 1_knowledge_pipeline/cleaners.py (ูุณุฎุฉ ูุญุฏุซุฉ ูุขููุฉ)
# # -----------------------------------------------------------------------------
# # ูุฐู ุงููุญุฏุฉ ูุณุคููุฉ ุนู ุชูุธูู ุงููุญุชูู ุงููุตู ูููุณุชูุฏุงุช ุงููุญููุฉ.
# # -----------------------------------------------------------------------------

# import re
# from typing import List
# from langchain_core.documents import Document

# def clean_documents(documents: List[Document]) -> List[Document]:
#     """
#     ูููู ุจุชูููุฐ ุณูุณูุฉ ูู ุนูููุงุช ุงูุชูุธูู ุนูู ูุญุชูู ูู ูุณุชูุฏ ูู ุงููุงุฆูุฉ.
#     ุชู ุชุตููู ูุฐู ุงููุณุฎุฉ ูุชููู ุฃูู ุนุฏูุงููุฉ ูุชุญุงูุธ ุนูู ุชูุณูู ุงูููุงุฆู.
#     """
#     print(f"\n[+] ุงููุฑุญูุฉ 2: ุชูุธูู {len(documents)} ุฌุฒุก/ุตูุญุฉ...")
    
#     for doc in documents:
#         content = doc.page_content
        
#         # 1. ุฅุฒุงูุฉ ุงููุณุงูุงุช ุงูุจูุถุงุก ุงูุฒุงุฆุฏุฉ ูู ุงูุจุฏุงูุฉ ูุงูููุงูุฉ
#         content = content.strip()
        
#         # 2. ุงุณุชุจุฏุงู 3 ููุงุตู ุฃุณุทุฑ ุฃู ุฃูุซุฑ ุจูุงุตููู ููุท ููุญูุงุธ ุนูู ุงูููุฑุงุช
#         content = re.sub(r'\n{3,}', '\n\n', content)
        
#         # 3. ุงุณุชุจุฏุงู ุงููุณุงูุงุช ุงููุชุนุฏุฏุฉ ุจูุณุงูุฉ ูุงุญุฏุฉ (ุจุงุณุชุซูุงุก ููุงุตู ุงูุฃุณุทุฑ)
#         content = re.sub(r' +', ' ', content)

#         # 4. (ููู) ุฅุฒุงูุฉ ุงููุณุงูุงุช ุจูู ุงููููุงุช ุงูุนุฑุจูุฉ ูุงูุญุฑูู ุงููุงุชูููุฉ ุงููุชุตูุฉ
#         # ูุซุงู: "ุงูุดุจูุงุชุงูุนุตุจูุฉ" -> "ุงูุดุจูุงุช ุงูุนุตุจูุฉ"
#         # ูุฐุง ูุนุงูุฌ ูุดููุฉ ุดุงุฆุนุฉ ูู ูุณุฎ ุงููุตูุต ูู PDF
#         content = re.sub(r'([_,-])', ' ', content)
#         content = re.sub(r'([ุง-ู])([A-Za-z])', r'\1 \2', content)
#         content = re.sub(r'([A-Za-z])([ุง-ู])', r'\1 \2', content)

#         # 5. (ุงุฎุชูุงุฑู ูุขูู) ุฅุฒุงูุฉ ููุงุตู ุงูุฃุณุทุฑ ุฏุงุฎู ุงูุฌูู ุงูุชู ุชูุชูู ุจููุทุฉ
#         # ูุฐุง ุงูุณุทุฑ ุขูู ูุฃูู ูุณุชูุฏู ููุท ุงูุฃุณุทุฑ ุงูุชู ูู ุฌุฒุก ูู ููุณ ุงูุฌููุฉ
#         # content = re.sub(r'(?<=[^\n.!?])\n(?=[^\n\s])', ' ', content)
#         # ุณูููู ุจุชุนุทูู ูุฐุง ุงูุณุทุฑ ุญุงูููุง ูุฃูู ูุฏ ูููู ูุง ูุฒุงู ุนุฏูุงูููุง.
#         # ุงูุฃูุถู ูู ุงูุงุนุชูุงุฏ ุนูู ุงูุชูุทูุน ุงูุฌูุฏ ูุงุญููุง.

#         # ุชุญุฏูุซ ูุญุชูู ุงููุณุชูุฏ
#         doc.page_content = content
            
#     print("[*] ุงูุชูู ุชูุธูู ุงููุตูุต.")
#     return documents
# 1_knowledge_pipeline/cleaners.py (ุงูุฅุตุฏุงุฑ ุงูููุงุฆู ูุน ูุนุงูุฌุฉ ุงููุต ุงูููููุจ)
import re
from typing import List
from langchain_core.documents import Document

# --- ุงุณุชูุฑุงุฏ ุงูููุชุจุงุช ุงูุฌุฏูุฏุฉ ---
try:
    import arabic_reshaper
    from bidi.algorithm import get_display
    RESHAPER_INSTALLED = True
except ImportError:
    RESHAPER_INSTALLED = False
    print("โ๏ธ ุชุญุฐูุฑ: ููุชุจุงุช 'arabic-reshaper' ู 'python-bidi' ุบูุฑ ูุซุจุชุฉ. ูู ูุชู ุฅุตูุงุญ ุงููุต ุงูููููุจ.")
    print("๐ก ููุชุซุจูุชุ ูู ุจุชุดุบูู: pip install arabic-reshaper python-bidi")


def fix_arabic_text(text: str) -> str:
    """
    ูุฃุฎุฐ ูุตูุง ูุฏ ูุญุชูู ุนูู ุญุฑูู ุนุฑุจูุฉ ููููุจุฉ ุฃู ูููุตูุฉ ููููู ุจุฅุตูุงุญู.
    """
    if not RESHAPER_INSTALLED or not text:
        return text
    
    # 1. ุฅุนุงุฏุฉ ุชุดููู ุงููุต ูุฑุจุท ุงูุญุฑูู ุงูุนุฑุจูุฉ
    reshaped_text = arabic_reshaper.reshape(text)
    
    # 2. ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงููุต ูุถูุงู ุงูุนุฑุถ ุงูุตุญูุญ ูู ุงููููู ุฅูู ุงููุณุงุฑ
    bidi_text = get_display(reshaped_text)
    
    return bidi_text

def clean_documents(documents: List[Document]) -> List[Document]:
    """
    ูููู ุจุชูููุฐ ุณูุณูุฉ ูู ุนูููุงุช ุงูุชูุธููุ ุจูุง ูู ุฐูู ุฅุตูุงุญ ุงููุต ุงูุนุฑุจู ุงูููููุจ.
    """
    print(f"\n[+] ุงููุฑุญูุฉ 2: ุชูุธูู {len(documents)} ุฌุฒุก/ุตูุญุฉ (ูุน ุฅุตูุงุญ ุงููุต ุงูุนุฑุจู)...")
    
    for doc in documents:
        content = doc.page_content
        
        # --- ุงูุฎุทูุฉ ุงูุฌุฏูุฏุฉ ูุงูุญุงุณูุฉ ---
        # 1. ุฅุตูุงุญ ุงููุต ุงูุนุฑุจู ุงูููููุจ ุฃููุงู
        content = fix_arabic_text(content)
        
        # 2. ุฅุฒุงูุฉ ุงููุณุงูุงุช ุงูุจูุถุงุก ุงูุฒุงุฆุฏุฉ ูู ุงูุจุฏุงูุฉ ูุงูููุงูุฉ
        content = content.strip()
        
        # 3. ุชูุญูุฏ ููุงุตู ุงูุฃุณุทุฑ (ูุง ุชุฒูุฏ ุนู ูุงุตููู)
        content = re.sub(r'\n{3,}', '\n\n', content)
        
        # 4. ุงุณุชุจุฏุงู ุงููุณุงูุงุช ุงููุชุนุฏุฏุฉ ุจูุณุงูุฉ ูุงุญุฏุฉ
        content = re.sub(r' +', ' ', content)

        # 5. ุฅุฒุงูุฉ ุงููุณุงูุงุช ุจูู ุงููููุงุช ุงูุนุฑุจูุฉ ูุงููุงุชูููุฉ
        content = re.sub(r'([ุง-ู])([A-Za-z])', r'\1 \2', content)
        content = re.sub(r'([A-Za-z])([ุง-ู])', r'\1 \2', content)

        # ุชุญุฏูุซ ูุญุชูู ุงููุณุชูุฏ ุจุงููุต ุงููุธูู
        doc.page_content = content
            
    print("[*] ุงูุชูู ุชูุธูู ุงููุตูุต ูุฅุตูุงุญูุง.")
    return documents
